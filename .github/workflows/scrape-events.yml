name: ğŸƒ Scrape Race Events Daily

on:
  # ExÃ©cution quotidienne Ã  6h du matin UTC
  schedule:
    - cron: '0 6 * * *'
  
  # Permet l'exÃ©cution manuelle depuis l'interface GitHub
  workflow_dispatch:

  # ExÃ©cution Ã  chaque push sur main (pour les tests)
  push:
    branches:
      - main
    paths:
      - 'scraper/**'
      - '.github/workflows/scrape-events.yml'

concurrency:
  group: scrape-events-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: scraper/requirements.txt

      - name: ğŸ“¦ Install dependencies
        run: |
          cd scraper
          pip install -r requirements.txt

      - name: ğŸƒ Run scraper
        run: |
          cd scraper
          python main.py
        env:
          PYTHONUNBUFFERED: 1

      - name: ğŸ›¡ï¸ Validate output quality gates
        run: |
          cd scraper
          python validate_output.py --events ../events.json --report quality_report.json

      - name: ğŸ“Š Show results
        run: |
          echo "ğŸ“‹ Events JSON Summary:"
          cat events.json | python -c "import sys, json; d=json.load(sys.stdin); print(f'Total events: {d[\"totalEvents\"]}'); print(f'Last updated: {d[\"lastUpdated\"]}'); print(f'Disciplines: {d.get(\"quality\", {}).get(\"disciplines\", {})}')"
          echo "ğŸ“‹ Quality report:"
          cat scraper/quality_report.json

      - name: ğŸ“¤ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add the events.json file
          git add events.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”„ Update events.json - $(date '+%Y-%m-%d %H:%M UTC')"
            git push
          fi

      - name: ğŸ“ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: events-and-quality
          path: |
            events.json
            scraper/summary.json
            scraper/quality_report.json
          retention-days: 30
